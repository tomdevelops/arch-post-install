#!/bin/sh

echo '###############################'
echo '##                           ##'
echo '##   üì¶ Install packages     ##'
echo '##                           ##'
echo '###############################'
echo

if ! builtin type -p 'yay' >/dev/null 2>&1; then
  CWD=`pwd`
  echo 'ü•£ Installing yay'
  tmpdir="$(command mktemp -d)"
  command cd "${tmpdir}" || return 1
  sudo pacman -Sy --needed --noconfirm base base-devel git
  git clone https://aur.archlinux.org/yay-bin.git
  cd yay-bin
  makepkg -si
  cd $CWD
fi

echo 'üì¶ Installing base packages'
yay --noconfirm

echo 'üì¶ Installing packages'
curl -Lks https://raw.githubusercontent.com/tomdevelops/arch-post-install/main/packages.csv | tail -n +2 | cut -d, -f1 | yay -Sy --noconfirm -

# echo 'Configuring dotfiles'
# if [ "$1" != "ssh" ]
# then
#  # Use https instead of ssh
#  curl -Lks https://raw.githubusercontent.com/tomdevelops/dotfiles/main/setup | /bin/bash
#else
#  curl -Lks https://raw.githubusercontent.com/tomdevelops/dotfiles/main/setup | /bin/bash -s ssh
#fi

if [ -f /etc/systemd/system/display-manager.service ]
then
  echo 'üîó Removing existing display manager link'
  sudo rm /etc/systemd/system/display-manager.service
fi

echo
echo 'üßπ Cleaning up unwanted packages'
yay -Qtdq | yay -Rns --noconfirm - 2>/dev/null
echo

echo
echo '###################################################'
echo '##                                               ##'
echo '##          üëè Installation Complete             ##'
echo '##      reboot to use the new configurations     ##'
echo '##                                               ##'
echo '###################################################'
echo

# clearing the input buffer
while read -r -t 0; do
    read -r
done

printf "Would you like to reboot now? (y/N): "
read -r reboot
reboot_lower=$(tr '[:upper:]' '[:lower:]' <<< "$reboot")

if [ "$reboot_lower" = "y" ]; then
    echo "Rebooting..."
    reboot
fi
